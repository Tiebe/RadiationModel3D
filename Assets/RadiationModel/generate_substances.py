atomic_numbers = {
    0: 'Neutron',
    1: 'Hydrogen',
    2: 'Helium',
    3: 'Lithium',
    4: 'Beryllium',
    5: 'Boron',
    6: 'Carbon',
    7: 'Nitrogen',
    8: 'Oxygen',
    9: 'Fluorine',
    10: 'Neon',
    11: 'Sodium',
    12: 'Magnesium',
    13: 'Aluminum',
    14: 'Silicon',
    15: 'Phosphorus',
    16: 'Sulfur',
    17: 'Chlorine',
    18: 'Argon',
    19: 'Potassium',
    20: 'Calcium',
    21: 'Scandium',
    22: 'Titanium',
    23: 'Vanadium',
    24: 'Chromium',
    25: 'Manganese',
    26: 'Iron',
    27: 'Cobalt',
    28: 'Nickel',
    29: 'Copper',
    30: 'Zinc',
    31: 'Gallium',
    32: 'Germanium',
    33: 'Arsenic',
    34: 'Selenium',
    35: 'Bromine',
    36: 'Krypton',
    37: 'Rubidium',
    38: 'Strontium',
    39: 'Yttrium',
    40: 'Zirconium',
    41: 'Niobium',
    42: 'Molybdenum',
    43: 'Technetium',
    44: 'Ruthenium',
    45: 'Rhodium',
    46: 'Palladium',
    47: 'Silver',
    48: 'Cadmium',
    49: 'Indium',
    50: 'Tin',
    51: 'Antimony',
    52: 'Tellurium',
    53: 'Iodine',
    54: 'Xenon',
    55: 'Cesium',
    56: 'Barium',
    57: 'Lanthanum',
    58: 'Cerium',
    59: 'Praseodymium',
    60: 'Neodymium',
    61: 'Promethium',
    62: 'Samarium',
    63: 'Europium',
    64: 'Gadolinium',
    65: 'Terbium',
    66: 'Dysprosium',
    67: 'Holmium',
    68: 'Erbium',
    69: 'Thulium',
    70: 'Ytterbium',
    71: 'Lutetium',
    72: 'Hafnium',
    73: 'Tantalum',
    74: 'Tungsten',
    75: 'Rhenium',
    76: 'Osmium',
    77: 'Iridium',
    78: 'Platinum',
    79: 'Gold',
    80: 'Mercury',
    81: 'Thallium',
    82: 'Lead',
    83: 'Bismuth',
    84: 'Polonium',
    85: 'Astatine',
    86: 'Radon',
    87: 'Francium',
    88: 'Radium',
    89: 'Actinium',
    90: 'Thorium',
    91: 'Protactinium',
    92: 'Uranium',
    93: 'Neptunium',
    94: 'Plutonium',
    95: 'Americium',
    96: 'Curium',
    97: 'Berkelium',
    98: 'Californium',
    99: 'Einsteinium',
    100: 'Fermium',
    101: 'Mendelevium',
    102: 'Nobelium',
    103: 'Lawrencium',
    104: 'Rutherfordium',
    105: 'Dubnium',
    106: 'Seaborgium',
    107: 'Bohrium',
    108: 'Hassium',
    109: 'Meitnerium',
    110: 'Darmstadtium',
    111: 'Roentgenium',
    112: 'Copernicium',
    113: 'Nihonium',
    114: 'Flerovium',
    115: 'Moscovium',
    116: 'Livermorium',
    117: 'Tennessine',
    118: 'Oganesson'
}

element_symbols = {
    "H": 1,
    "He": 2,
    "Li": 3,
    "Be": 4,
    "B": 5,
    "C": 6,
    "N": 7,
    "O": 8,
    "F": 9,
    "Ne": 10,
    "Na": 11,
    "Mg": 12,
    "Al": 13,
    "Si": 14,
    "P": 15,
    "S": 16,
    "Cl": 17,
    "Ar": 18,
    "K": 19,
    "Ca": 20,
    "Sc": 21,
    "Ti": 22,
    "V": 23,
    "Cr": 24,
    "Mn": 25,
    "Fe": 26,
    "Co": 27,
    "Ni": 28,
    "Cu": 29,
    "Zn": 30,
    "Ga": 31,
    "Ge": 32,
    "As": 33,
    "Se": 34,
    "Br": 35,
    "Kr": 36,
    "Rb": 37,
    "Sr": 38,
    "Y": 39,
    "Zr": 40,
    "Nb": 41,
    "Mo": 42,
    "Tc": 43,
    "Ru": 44,
    "Rh": 45,
    "Pd": 46,
    "Ag": 47,
    "Cd": 48,
    "In": 49,
    "Sn": 50,
    "Sb": 51,
    "Te": 52,
    "I": 53,
    "Xe": 54,
    "Cs": 55,
    "Ba": 56,
    "La": 57,
    "Ce": 58,
    "Pr": 59,
    "Nd": 60,
    "Pm": 61,
    "Sm": 62,
    "Eu": 63,
    "Gd": 64,
    "Tb": 65,
    "Dy": 66,
    "Ho": 67,
    "Er": 68,
    "Tm": 69,
    "Yb": 70,
    "Lu": 71,
    "Hf": 72,
    "Ta": 73,
    "W": 74,
    "Re": 75,
    "Os": 76,
    "Ir": 77,
    "Pt": 78,
    "Au": 79,
    "Hg": 80,
    "Tl": 81,
    "Pb": 82,
    "Bi": 83,
    "Po": 84,
    "At": 85,
    "Rn": 86,
    "Fr": 87,
    "Ra": 88,
    "Ac": 89,
    "Th": 90,
    "Pa": 91,
    "U": 92,
    "Np": 93,
    "Pu": 94,
    "Am": 95,
    "Cm": 96,
    "Bk": 97,
    "Cf": 98,
    "Es": 99,
    "Fm": 100,
    "Md": 101,
    "No": 102,
    "Lr": 103,
    "Rf": 104,
    "Db": 105,
    "Sg": 106,
    "Bh": 107,
    "Hs": 108,
    "Mt": 109,
    "Ds": 110,
    "Rg": 111,
    "Cn": 112,
    "Nh": 113,
    "Fl": 114,
    "Mc": 115,
    "Lv": 116,
    "Ts": 117,
    "Og": 118
}


def timeWithUnitToSeconds(time, unit):
    if unit == "ys":
        return time / 1000000000000000000000000
    if unit == "zs":
        return time / 1000000000000000000000
    if unit == "as":
        return time / 1000000000000000000
    if unit == "fs":
        return time / 1000000000000000
    if unit == "ps":
        return time / 1000000000000
    if unit == "ns":
        return time / 1000000000
    if unit == "us":
        return time / 1000000
    if unit == "ms":
        return time / 1000
    if unit == "s":
        return time
    if unit == "m":
        return time * 60
    if unit == "h":
        return time * 3600
    if unit == "d":
        return time * 86400
    if unit == "y":
        return time * 31556952
    if unit == "ky":
        return time * 31556952 * 1000
    if unit == "My":
        return time * 31556952 * 1000000
    if unit == "Gy":
        return time * 31556952 * 1000000000
    if unit == "Ty":
        return time * 31556952 * 1000000000000
    if unit == "Py":
        return time * 31556952 * 1000000000000000
    if unit == "Ey":
        return time * 31556952 * 1000000000000000000
    if unit == "Zy":
        return time * 31556952 * 1000000000000000000000
    if unit == "Yy":
        return time * 31556952 * 1000000000000000000000000
    print(f"Unknown unit: {unit}")

def keVToAtomicMass(massExcessKeV):
    return massExcessKeV / 931494.103472

def atomicMassToKeV(atomicMass):
    return atomicMass * 931494.103472

class Isotope:
    def __init__(self, name, halfLife, atomicWeight, massNumber, elementNumber, massKeV):
        self.name = name
        self.halfLife = halfLife
        self.atomicWeight = atomicWeight
        self.decayProducts = []
        self.massNumber = massNumber
        self.elementNumber = elementNumber
        self.massKeV = massKeV

    def setDecayProducts(self, products):
        self.decayProducts = products


def getAlphaDecayProducts(isotope: Isotope, chance):
    startingMass = isotope.massNumber
    startingElement = isotope.elementNumber

    # Alpha decay results in a loss of 4 mass units and 2 atomic number units
    massNumber = startingMass - 4
    elementNumber = startingElement - 2

    return {
        "chance": float(chance.split(' ')[0]) / 100,
        "results": [{ "type": "alpha" }, { "type": "substance", "mass": massNumber, "element": elementNumber }]
    }


def getBetaDecayProducts(isotope: Isotope, resultChance, decayType):
    add = 0
    betaRelease = True
    amount = 1
    charge = 0
    if len(decayType) > 2:
        if decayType != "EC+B+":
            amount = int(decayType[0])
    if decayType.endswith('B-'):
        add = amount
        charge = -amount
    elif decayType.endswith('B+') or decayType.endswith('e+'):
        add = -amount
        charge = amount
    elif decayType.endswith('EC'):
        add = -amount
        betaRelease = False
    if decayType == "EC+B+":
        add = 2
        charge = 1


    startingMass = isotope.massNumber
    startingElement = isotope.elementNumber

    # Beta decay results in a loss of 0 mass units and a gain of 1 atomic number unit
    massNumber = startingMass
    elementNumber = startingElement + add

    resultsList = []
    if betaRelease:
        resultsList.append({ "type": "beta", "charge": charge })

    if '[' in resultChance:
        # Handle cases with multiple possible results
        percentage = resultChance.split('[')[0]
        results = resultChance.split('[')[1].replace(']', '').split(',')

        result1 = resultsList.copy()
        result1.append({ "type": "substance", "mass": massNumber, "element": elementNumber })
        result2 = resultsList.copy()
        result2.append({ "type": "substance", "mass": massNumber, "element": elementNumber, "info": "m" })

        return [{
            "chance": (float(percentage) / 100) * (float(results[0].split('=')[1]) / 100),
            "results": result1
        }, {
            "chance": (float(percentage) / 100) * (float(results[1].split('=')[1]) / 100),
            "results": result2
        }]

    else:
        result = resultsList.copy()
        result.append({ "type": "substance", "mass": massNumber, "element": elementNumber })
        return [{
            "chance": float(resultChance.split(' ')[0]) / 100,
            "results": result
        }]


def getIsomericTransitionProducts(isotope: Isotope, resultChance):
    if '[' in resultChance:
        # Handle cases with multiple possible results
        percentage = resultChance.split('[')[0].split(" ")[0]
        results = resultChance.split('[')[1].replace(']', '').split(',')

        return [{
            "chance": (float(percentage) / 100) * (float(results[0].split('=')[1]) / 100),
            "results": [{ "type": "gamma" }, { "type": "substance", "mass": isotope.massNumber, "element": isotope.elementNumber }]
        }, {
            "chance": (float(percentage) / 100) * (float(results[1].split('=')[1]) / 100),
            "results": [{ "type": "gamma" }, { "type": "substance", "mass": isotope.massNumber, "element": isotope.elementNumber, "info": "m" }]
        }]
    else:
        return [{
            "chance": float(resultChance.split(' ')[0]) / 100,
            "results": [{ "type": "gamma" }, { "type": "substance", "mass": isotope.massNumber, "element": isotope.elementNumber }]
        }]


def getSpontaneousFissionProducts(isotope: Isotope, resultChance):
    return {
        "chance": float(resultChance.split(' ')[0]) / 100,
        "results": []
    }


def getProtonEmissionProducts(isotope, resultChance, amount = 1):
    return {
        "chance": float(resultChance.split(' ')[0]) / 100,
        "results": [{ "type": "proton" }, { "type": "substance", "mass": isotope.massNumber - amount, "element": isotope.elementNumber - amount }]
    }


def getNeutronEmissionProducts(isotope, resultChance, amount = 1):
    return {
        "chance": float(resultChance.split(' ')[0]) / 100,
        "results": [{ "type": "neutron" }, { "type": "substance", "mass": isotope.massNumber - amount, "element": isotope.elementNumber }]
    }


def getParticleEmissionProducts(isotope, decay_type, resultChance):
    particlesList = decay_type.split('+')
    particles = []
    leftOverMass = isotope.massNumber
    leftOverElement = isotope.elementNumber
    for particle in particlesList:
        massNumber = int(''.join(filter(str.isdigit, particle)))
        elementNumber = element_symbols[particle.replace(str(massNumber), '')]

        particles.append({ "type": "substance", "mass": massNumber, "element": elementNumber })
        leftOverMass -= massNumber
        leftOverElement -= elementNumber

    particles.append({ "type": "substance", "mass": leftOverMass, "element": leftOverElement })
    return {
        "chance": float(resultChance.split(' ')[0]) / 100,
        "results": particles
    }


def parseDecayModes(isotope: Isotope, decayModes):
    decayProducts = []

    for decayEntry in decayModes:
        decayEntry = decayEntry.replace('#', '').strip()
        # Splitting by '=' to separate decay type and percentage
        if '?' in decayEntry or decayEntry == '':
            continue
        if any(char in decayEntry for char in ['=', '~', '<', '>']):
            #print(f"Decay entry: {decayEntry}")
            decay_type, resultChance = decayEntry.replace('~', '=').replace('<', '=').replace('>', '=').split('=', 1)
            if decay_type == 'IS' or decay_type == 'd' or decay_type == 'B':
                continue
            # skip beta delayed emission
            if (decay_type.startswith('B+') or decay_type.startswith('B-')) and len(decay_type) > 2:
                continue

            if decay_type == 'A': # Alpha decay
                decayProducts.append(getAlphaDecayProducts(isotope, resultChance))
            elif decay_type.endswith('B-') or decay_type.endswith('B+') or decay_type.endswith('EC') or decay_type.endswith("e+"): # Beta decay
                decayProducts.extend(getBetaDecayProducts(isotope, resultChance, decay_type))
            elif decay_type == 'IT': # Isomeric transition
                decayProducts.extend(getIsomericTransitionProducts(isotope, resultChance))
            elif decay_type == 'SF': # Spontaneous fission
                decayProducts.append(getSpontaneousFissionProducts(isotope, resultChance))
            elif decay_type == 'p': # Proton emission
                decayProducts.append(getProtonEmissionProducts(isotope, resultChance))
            elif decay_type == 'n': # Neutron emission
                decayProducts.append(getNeutronEmissionProducts(isotope, resultChance))
            elif decay_type == '2n': # Two-neutron emission
                decayProducts.append(getNeutronEmissionProducts(isotope, resultChance, 2))
            elif decay_type == '2p': # Two-proton emission
                decayProducts.append(getProtonEmissionProducts(isotope, resultChance, 2))
            elif decay_type == '3p':
                decayProducts.append(getProtonEmissionProducts(isotope, resultChance, 3))
            else:
                # probably a particle emission
                decayProducts.append(getParticleEmissionProducts(isotope, decay_type, resultChance))
        else:
            # Handle cases without an explicit percentage
            print(f"Unknown format or missing percentage: '{decayEntry}'")

   # print(decayProducts)
    return decayProducts


def parseDatabase():
    with open("nubase.txt", "r") as file:
        lines = file.readlines()
        isotopes = []
        for line in lines:
            line = line.replace('\n', '')
            if line[0] == "#":
                continue

            mass = int(line[0:3])
            atomicNumber = int(line[4:7])
            element = atomic_numbers[atomicNumber]
            s = line[16:17].strip()
            massText = line[18:31].replace('#', '').strip()
            if massText == '':
                continue
            massExcessKeV = float(massText)
            atomicWeight = mass + keVToAtomicMass(massExcessKeV)
            halfLifeText = line[69:78].replace('#', '').strip().replace('>', '').replace('<', '').replace('~', '')
            halfLifeUnit = line[78:80].replace('#', '').strip()

            halfLife = 0
            if halfLifeText == "stbl" or halfLifeText == 'p-unst' or halfLifeText == '':
                halfLife = 0
            else:
                halfLife = timeWithUnitToSeconds(float(halfLifeText), halfLifeUnit)

            massKeV = atomicMassToKeV(mass) + massExcessKeV
            isotope = Isotope(element + str(mass) + s, halfLife, atomicWeight, mass, atomicNumber, massKeV)

            decayModes = line[119:209].strip().split(';')
            #print(f"Line: {line}")
            isotope.setDecayProducts(parseDecayModes(isotope, decayModes))
            isotopes.append(isotope)


    return isotopes


def getIsotopeFromMassElementInfo(isotopes, mass, element, info):
    name = atomic_numbers[element] + str(mass) + info
    return next((x for x in isotopes if x.name == name), None)

def eVToJoules(eV):
    return eV * 1.6021766339999 * (10 ** -19)

def getDecayProductString(isotopes, isotope, decayProduct, decayProducts):
    if decayProduct["type"] == "alpha":
        originalEnergy = isotope.massKeV
        finalEnergy = 3.7273794118*(10**6) # mass of alpha particle in keV
        for product in decayProducts["results"]:
            if product["type"] == "substance":
                newIsotope = getIsotopeFromMassElementInfo(isotopes, product["mass"], product["element"], product.get("info", ""))
                if newIsotope is not None:
                    finalEnergy += newIsotope.massKeV
                else:
                    print(f"Could not find isotope {product['mass']} {product['element']} {product.get('info', '')}")

        return f"new AlphaParticle({round(originalEnergy - finalEnergy, 5) * 1000})"
    if decayProduct["type"] == "beta":
        charge = decayProduct["charge"]
        originalEnergy = isotope.massKeV
        finalEnergy = 0
        for product in decayProducts["results"]:
            if product["type"] == "substance":
                newIsotope = getIsotopeFromMassElementInfo(isotopes, product["mass"], product["element"], product.get("info", ""))
                if newIsotope is not None:
                    finalEnergy += newIsotope.massKeV
                else:
                    print(f"Could not find isotope {product['mass']} {product['element']} {product.get('info', '')}")

        return f"new BetaParticle({charge}, {round(originalEnergy - finalEnergy, 5) * 1000})"
    if decayProduct["type"] == "gamma":
        originalEnergy = isotope.massKeV
        finalEnergy = 0
        for product in decayProducts["results"]:
            if product["type"] == "substance":
                newIsotope = getIsotopeFromMassElementInfo(isotopes, product["mass"], product["element"], product.get("info", ""))
                if newIsotope is not None:
                    finalEnergy += newIsotope.massKeV
                else:
                    print(f"Could not find isotope {product['mass']} {product['element']} {product.get('info', '')}")

        leftOverEnergyEV = (originalEnergy - finalEnergy) * 1000

        planckEV = 4.135667696 * (10 ** -15)
        c = 299792458.0

        if leftOverEnergyEV == 0:
            leftOverEnergyEV = 0.00000001

        wavelength = round(((planckEV * c) / leftOverEnergyEV) * 10**9, 5)
        return f"new GammaParticle({round(leftOverEnergyEV, 5), wavelength})"
    if decayProduct["type"] == "proton":
        return "new ProtonParticle()"
    if decayProduct["type"] == "neutron":
        return "new NeutronParticle()"
    if decayProduct["type"] == "substance":
        name = atomic_numbers[decayProduct["element"]] + str(decayProduct["mass"])
        if "info" in decayProduct:
            name += decayProduct["info"]
        return f"new {name}()"
    return ""

def generateFile(isotopes, isotope: Isotope):
    name = isotope.name
    halfLife = round(isotope.halfLife, 5)
    if halfLife == 0:
        halfLife = "double.PositiveInfinity"
    else:
        halfLife = str(halfLife) + "d"
    atomicWeight = round(isotope.atomicWeight, 5)

    decayProducts = ""
    for decayProduct in isotope.decayProducts:
        decayProducts += f"""            {{ {str(decayProduct["chance"])}d, new List<RadioactiveSubstance> {{ {', '.join([getDecayProductString(isotopes, isotope, product, decayProduct) for product in decayProduct["results"]])} }} }},
"""

    return f"""using System;
using System.Collections.Generic;
using RadiationModel.constants;

namespace RadiationModel.substances
{{
    public class {name} : RadioactiveSubstance
    {{
        public override string name {{ get; }} = "{name}";
        public override double halfLife {{ get; }} = {str(halfLife)};
        public override double atomicWeight {{ get; }} = {str(atomicWeight)}d;

        public override Dictionary<double, List<RadioactiveSubstance>> decayProducts {{ get; }} = new()
        {{
{decayProducts}
        }};
    }}
}}
    
    """


def generateSubstancesFile(isotopes):
    with open("Substances.cs", 'w') as file:
        file.write(f"""using System;
using System.Collections.Generic;
using RadiationModel.substances;

namespace RadiationModel
{{
    // list of all radioactive substances names with their respective class
    public static class Substances
    {{
        private static readonly Dictionary<string, Type> substances = new()
        {{
            {{ "AlphaParticle", typeof(AlphaParticle) }},
            {{ "BetaParticle", typeof(BetaParticle) }},
            {{ "GammaParticle", typeof(GammaParticle) }}, 

            {',\n            '.join([f'{{ "{isotope.name}", typeof({isotope.name}) }}' for isotope in isotopes])}
        }};
        
        public static RadioactiveSubstance GetSubstanceByName(string name)
        {{
            return (RadioactiveSubstance) Activator.CreateInstance(substances[name]);
        }}
    }}

}}
""")

def main():
    isotopes = parseDatabase()

    # create folder substances
    # create file for each isotope
    folder = "substances"
    import os
    if not os.path.exists(folder):
        os.makedirs(folder)

    for isotope in isotopes:
        with open(f"{folder}/{isotope.name}.cs", "w") as file:
            file.write(generateFile(isotopes, isotope))

    generateSubstancesFile(isotopes)

if __name__ == "__main__":
    main()
